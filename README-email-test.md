# さくらメール動作確認手順

## 1. 事前準備

### 1.1 環境変数の設定
`.env.local` ファイルで以下の項目を**実際の値に変更**してください：

```env
# さくらのメール設定（要変更）
SMTP_HOST=初期ドメイン名.sakura.ne.jp          # → あなたの初期ドメイン名
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=作成したメールアドレス                # → 実際のメールアドレス
SMTP_PASSWORD=メールパスワード                  # → 実際のパスワード

# メール送信設定
MAIL_FROM_ADDRESS=作成したメールアドレス        # → 実際のメールアドレス
MAIL_FROM_NAME=掲示板システム
MAIL_REPLY_TO=作成したメールアドレス            # → 実際のメールアドレス
```

### 1.2 必要な設定値の確認

**さくらインターネットの管理画面で確認すべき項目：**
- 初期ドメイン名（例：`abcd1234.sakura.ne.jp`）
- 作成したメールアドレス（例：`info@your-domain.com`）
- メールパスワード

## 2. テスト実行

### 2.1 基本テスト（SMTP接続確認）
```bash
# SMTP接続のみをテスト
node scripts/test-email.js
```

### 2.2 指定メールアドレスへの送信テスト
```bash
# 特定のメールアドレスに送信
node scripts/test-email.js your-email@gmail.com
```

## 3. 期待される結果

### 3.1 成功時の出力例
```
============================================================
📧 さくらメール動作確認テスト
============================================================

📋 現在の設定:
SMTP_HOST: abcd1234.sakura.ne.jp
SMTP_PORT: 587
SMTP_USER: info@your-domain.com
SMTP_PASSWORD: ***設定済み***
MAIL_FROM_ADDRESS: info@your-domain.com

1️⃣ SMTP接続テスト
----------------------------------------
🔧 環境変数の検証中...
✅ 環境変数: OK
🔧 SMTP接続の作成中...
🔧 SMTP接続テスト中...
✅ SMTP接続: OK

2️⃣ テストメール送信
----------------------------------------
📤 テスト送信先: info@your-domain.com
🔧 テストメール送信中...
✅ テストメール送信成功: <message-id>
✅ テストメールを info@your-domain.com に送信しました
Message ID: <123456789@sakura.ne.jp>

============================================================
🎉 テスト完了
============================================================
```

## 4. トラブルシューティング

### 4.1 SMTP接続エラー
**エラー:** `ECONNREFUSED` or `ETIMEDOUT`
**原因:** ホスト名またはポート番号が間違っている
**対策:** さくらの管理画面でSMTP設定を再確認

### 4.2 認証エラー
**エラー:** `Invalid login: 535 authentication failed`
**原因:** メールアドレスまたはパスワードが間違っている
**対策:** 
- メールアドレスが正確に入力されているか確認
- パスワードを再設定してテスト

### 4.3 送信エラー
**エラー:** `553 mail from must equal authorized user`
**原因:** 送信元メールアドレスがSMTPユーザーと一致していない
**対策:** `MAIL_FROM_ADDRESS` を `SMTP_USER` と同じにする

## 5. セキュリティチェック

### 5.1 接続の暗号化確認
- ポート587でTLS接続が使用されている
- パスワードが平文で送信されていない

### 5.2 メール内容の確認
- HTMLメールが正しく表示される
- 日本語文字化けがない
- リンクが正常に動作する

## 6. 次のステップ

テストが成功したら：

1. **本格的な統合テスト**
   ```bash
   npm run dev
   # アプリケーションでメール送信機能をテスト
   ```

2. **API エンドポイントの作成**
   - `/api/auth/send-verification`
   - `/api/auth/send-password-reset`

3. **フロントエンドとの統合**
   - 登録フォームからのメール送信
   - パスワードリセット機能

## 7. 本番環境での注意点

- 送信数制限：1000通/時間
- DNS設定（SPF/DKIM）の確認
- バウンスメール処理の実装
- 配信停止機能の実装

## 8. 詳細なトラブルシューティング

実装時に発生した具体的なエラーケースと解決策については、以下の詳細ドキュメントを参照してください：

📄 **[メール送信機能 トラブルシューティングガイド](./docs/email-troubleshooting-guide.md)**

このガイドには以下の内容が含まれています：
- 実際に発生したエラーの時系列
- 各エラーの根本原因分析
- 具体的な解決方法とコード例
- さくらインターネット固有の設定要注意点
- 段階的診断フローチャート