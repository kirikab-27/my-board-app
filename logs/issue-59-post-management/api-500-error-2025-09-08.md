# API 500エラー記録

## 発生日時（第1回）

2025-09-08 23:52 JST

## 発生日時（第2回）

2025-09-09 07:10 JST

## エラー概要

管理者投稿管理ページアクセス時にAPI 500エラーが発生（再発）

## エラー詳細

### エラーメッセージ

```
Failed to fetch posts: Error: エラー: 500 Internal Server Error
    at PostManagementGrid.useCallback[fetchPosts]
    (webpack-internal:///(app-pages-browser)/./src/app/admin/posts/PostManagementGrid.tsx:95:27)
```

### APIエンドポイント

```
GET /api/admin/posts?page=1&limit=25&sortBy=createdAt&sortOrder=desc
```

## 原因分析

### 推定原因

1. **セッション認証の問題**
   - `session.user.role` へのアクセスで型エラー
   - NextAuth設定の不整合

2. **データベース接続**
   - MongoDBモデルの参照エラー
   - Postモデルのフィールド不整合

3. **APIレスポンス形式**
   - 期待されるレスポンス形式と実際の形式の不一致

## 修正内容

### 1. セッション型チェック修正

```typescript
// 修正前
if (!session?.user || !['admin', 'moderator'].includes(session.user.role || ''))

// 修正後
const userRole = (session?.user as any)?.role;
if (!session?.user || !['admin', 'moderator'].includes(userRole))
```

### 2. エラーレスポンス形式統一

```typescript
// 統一されたエラーレスポンス
return NextResponse.json({ success: false, message: 'エラーメッセージ' }, { status: 403 });
```

### 3. Postモデルフィールド確認

- userIdフィールドの存在確認
- moderationDataの初期化

## 影響評価

- **影響範囲**: 管理者投稿管理機能全体
- **ユーザー影響**: 管理者が投稿管理できない
- **優先度**: 高（管理機能の中核）

## テスト結果

- **修正前**: 500エラー
- **修正後**: 正常動作確認予定

## 最終修正（第3回）

2025-09-09 実施

### 根本原因

Postモデルのフィールド構造とAPIの不一致：

- Postモデル: `userId`（文字列）、`authorName`、`authorRole`を使用
- APIが誤って`populate`や`moderationData`等の存在しないフィールドを参照

### 修正内容

1. populate呼び出しを削除（userIdは文字列なのでpopulate不要）
2. moderationData参照を実際のフィールド（reportCount、isDeleted等）に変更
3. レスポンス形式をPostモデルの実際のフィールドに合わせて修正

## 関連Issue

- Issue #59: 投稿管理システム（AI自動モデレーション）
