# Issue #47: RBACエラー修正記録

## 発生日時

2025-01-10 22:05 (JST)

## エラー内容

### 1. AdminLayoutEnhanced エクスポートエラー

```
Attempted import error: 'AdminLayoutEnhanced' is not exported from '@/components/admin/AdminLayoutEnhanced'
```

**影響ファイル**: 全管理画面ページ

- /admin/analytics
- /admin/audit-logs
- /admin/config
- /admin/dashboard
- /admin/posts
- /admin/security/2fa
- /admin/settings

**原因**: Issue #47の実装中にAdminLayoutEnhancedのエクスポートをnamed exportからdefault exportに変更したが、その後元に戻した際の不整合

### 2. AuditLogモデルのバリデーションエラー

```
AuditLog validation failed: retentionDate: Path `retentionDate` is required., hash: Path `hash` is required., details: Path `details` is required.
```

**原因**: RBACミドルウェアからAuditLogを作成する際、必須フィールドが不足している

### 3. Mongooseインデックス重複警告

```
[MONGOOSE] Warning: Duplicate schema index on {"retentionDate":1} found
[MONGOOSE] Warning: Duplicate schema index on {"timestamp":1} found
```

**原因**: スキーマ定義でindex: trueとschema.index()の両方を使用

## 修正内容

### 1. AdminLayoutEnhancedエクスポート修正

- export function AdminLayoutEnhanced（named export維持）
- 必要に応じてdefault exportも追加

### 2. RBACミドルウェアのAuditLog作成修正

- detailsフィールドの確実な設定
- retentionDateとhashはモデル側のpre-saveフックで生成されるはずだが、動作確認必要

### 3. AuditLogモデルのインデックス重複解消

- index: trueの削除またはschema.index()の削除

## 対応優先度

1. AdminLayoutEnhancedエクスポート（全管理画面に影響）
2. AuditLogバリデーションエラー（監査ログが記録されない）
3. インデックス重複警告（パフォーマンスのみ）

## 実施した修正内容

### 1. AdminLayoutEnhanced エクスポート修正（完了）

**ファイル**: `src/components/admin/AdminLayoutEnhanced.tsx`

- 関数定義で既に`export function`でexportされているため、重複exportを削除
- named exportは関数定義時点で提供済み
- default exportのみ追加して互換性確保

### 2. AuditLog バリデーションエラー修正（完了）

**ファイル**: `src/models/AuditLog.ts`

- retentionDateとhashをrequired: falseに変更（pre-saveフックで設定）
- detailsフィールドにdefault: {}を追加
- pre-saveフックでdetailsとtimestampのデフォルト値を確実に設定

**ファイル**: `src/middleware/rbac.ts`

- logSecurityEvent関数でdetailsを確実に設定（details || {}）

### 3. Mongooseインデックス重複警告修正（完了）

**ファイル**: `src/models/AuditLog.ts`

- timestampフィールドのindex: trueを削除（schema.indexで設定済み）
- retentionDateフィールドのindex: trueを削除（TTLインデックスで設定済み）

## 動作確認結果

- AdminLayoutEnhancedのexport/import問題は解決
- AuditLogの必須フィールドはpre-saveフックで自動設定
- Mongooseインデックス重複警告は解消予定（次回起動時）

## 注意事項

- 開発サーバー再起動時は.nextディレクトリのクリアが必要
- ポート競合時は別ポートを使用（例: 3012）
