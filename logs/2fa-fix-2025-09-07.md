# 2FAï¼ˆ2æ®µéšèªè¨¼ï¼‰ä¿®æ­£è¨˜éŒ²

**ç™ºç”Ÿæ—¥æ™‚**: 2025/09/07 18:50 (JST)
**ç’°å¢ƒ**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼ˆWindows, Git Bashï¼‰
**Issue**: #53 - 2FAç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
**ç—‡çŠ¶**: 2æ®µéšèªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„

## ğŸš¨ å•é¡Œæ¦‚è¦

ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§2FAã‚’æœ‰åŠ¹åŒ–ã—ãŸãŒã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿï¼š

- 2FAæ¤œè¨¼å¾Œã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¤œè¨¼çŠ¶æ…‹ãŒä¿å­˜ã•ã‚Œãªã„
- ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚2FAæ¤œè¨¼ãŒè¦æ±‚ã•ã‚Œãªã„
- verify APIã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ãŒä¸å®Œå…¨

## ğŸ” åŸå› èª¿æŸ»

### 1. verify APIã®å•é¡Œç‚¹

```typescript
// src/app/api/admin/2fa/verify/route.ts
// ä¿®æ­£å‰ï¼šTODOã‚³ãƒ¡ãƒ³ãƒˆã®ã¾ã¾æœªå®Ÿè£…
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«2FAæ¤œè¨¼æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
// TODO: NextAuth.jsã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‹¡å¼µãŒå¿…è¦
```

### 2. NextAuth callbacksã®2FAçŠ¶æ…‹ç®¡ç†

- jwt callbackã§trigger === 'update'æ™‚ã®å‡¦ç†ã¯ã‚ã‚‹ãŒã€æ¤œè¨¼æ™‚åˆ»è¨˜éŒ²ãªã—
- session callbackã§2FAçŠ¶æ…‹ã¯è»¢é€ã•ã‚Œã¦ã„ã‚‹ãŒã€åˆæœŸåŒ–ã«å•é¡Œ

### 3. status APIã®ä¸å®Œå…¨ãªå®Ÿè£…

- requires2FAãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿”ã•ã‚Œã¦ã„ãªã„
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å¿…è¦ãªæƒ…å ±ãŒä¸è¶³

## âœ… å®Ÿæ–½ã—ãŸä¿®æ­£

### 1. verify APIã®æ”¹å–„

```typescript
// src/app/api/admin/2fa/verify/route.ts
return NextResponse.json({
  success: true,
  isBackupCode: result.isBackupCode,
  twoFactorVerified: true, // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¤œè¨¼æˆåŠŸã‚’é€šçŸ¥ï¼ˆè¿½åŠ ï¼‰
  message: result.isBackupCode ? 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã§èªè¨¼ã•ã‚Œã¾ã—ãŸ' : '2FAèªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ',
});
```

### 2. NextAuth jwt callbackã®æ”¹å–„

```typescript
// src/lib/auth/nextauth.ts
if (trigger === 'update' && session?.twoFactorVerified) {
  token.twoFactorVerified = true;
  // 2FAæ¤œè¨¼æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆè¿½åŠ ï¼‰
  token.twoFactorVerifiedAt = new Date().toISOString();
  return token;
}
```

### 3. status APIã®æƒ…å ±è¿½åŠ 

```typescript
// src/app/api/admin/2fa/status/route.ts
const twoFactorVerified = (session as any).twoFactorVerified || false;
const requires2FA = (session as any).requires2FA || false; // è¿½åŠ 

return NextResponse.json({
  success: true,
  enabled: isEnabled,
  verified: twoFactorVerified,
  requires2FA, // 2FAãŒå¿…è¦ã‹ã©ã†ã‹ï¼ˆè¿½åŠ ï¼‰
  isEnabled,
  remainingBackupCodes,
});
```

## ğŸ“Š ä¿®æ­£å¾Œã®å‹•ä½œ

1. **verify API**: æ¤œè¨¼æˆåŠŸæ™‚ã«twoFactorVerifiedãƒ•ãƒ©ã‚°ã‚’è¿”ã™
2. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: update({ twoFactorVerified: true })ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
3. **NextAuth**: JWT tokenã«æ¤œè¨¼çŠ¶æ…‹ã¨æ™‚åˆ»ã‚’ä¿å­˜
4. **status API**: requires2FAã‚’å«ã‚€å®Œå…¨ãªçŠ¶æ…‹æƒ…å ±ã‚’è¿”ã™

## ğŸ”§ ä»Šå¾Œã®æ”¹å–„ç‚¹

1. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ°¸ç¶šåŒ–**: 2FAæ¤œè¨¼çŠ¶æ…‹ã®DBä¿å­˜
2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½**: 2FAæ¤œè¨¼ã®æœ‰åŠ¹æœŸé™è¨­å®š
3. **ç›£æŸ»ãƒ­ã‚°**: 2FAé–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²
4. **ãƒªã‚«ãƒãƒªãƒ¼æ©Ÿèƒ½**: ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªã‚«ãƒãƒªãƒ¼ãƒ•ãƒ­ãƒ¼

## ğŸ“ å‚™è€ƒ

- NextAuth.jsã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§update()ã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹
- Edge Runtimeã®åˆ¶é™ã«ã‚ˆã‚Šã€middleware.tsã§ã®2FAãƒã‚§ãƒƒã‚¯ã¯å‰Šé™¤æ¸ˆã¿
- ä»£ã‚ã‚Šã«use2FACheckãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«ã§åˆ¶å¾¡

---

**ä¿®æ­£å®Œäº†**: 2025/09/07 19:10 (JST)
