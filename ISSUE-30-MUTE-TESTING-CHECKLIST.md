# Issue #30 Phase 2-A ミュート機能 包括的動作確認チェックリスト

## 📋 実装概要

### ✅ 実装完了機能
- **Muteモデル**: MongoDB Mongoose スキーマ・インデックス最適化・TTL自動削除
- **ミュート管理UI**: MuteManager.tsx 包括的管理画面・タブ切り替え・統計表示
- **API統合**: GET/POST/DELETE/PATCH エンドポイント完全実装
- **プライバシー統合**: profile/privacy ページでの完全統合・タブ切り替え対応

### 🎯 ミュート機能種別
1. **ユーザーミュート**: 特定ユーザーからのコンテンツ非表示
2. **キーワードミュート**: 指定キーワード含有コンテンツ非表示（正規表現・大小文字区別対応）
3. **ハッシュタグミュート**: 特定ハッシュタグコンテンツ非表示
4. **ドメインミュート**: 特定ドメインからのコンテンツ非表示（将来拡張用）

### ⏰ ミュート期間設定
- **永続ミュート**: 手動解除まで継続
- **期間限定ミュート**: 指定日時で自動解除・MongoDB TTL機能活用

### 🎯 適用範囲設定
- **投稿**: 投稿一覧・詳細ページでの非表示
- **コメント**: コメント表示時の非表示
- **通知**: 通知一覧・プッシュ通知の非表示
- **タイムライン**: フォローユーザー投稿フィードでの非表示
- **検索結果**: 検索結果でのコンテンツ非表示

---

## 🧪 動作確認チェックリスト

### 1. ミュート管理画面アクセス ✅

#### 1.1 基本アクセス
- [ ] `/profile/privacy` ページにアクセス可能
- [ ] ログイン必須認証が動作（未認証時は `/login?callbackUrl=/profile/privacy` にリダイレクト）
- [ ] プライバシー設定タブから「ミュート管理」タブに切り替え可能
- [ ] MuteManagerコンポーネントが正常に表示

#### 1.2 統計情報表示
- [ ] ミュート統計カードが表示（総数・ユーザー・キーワード・ハッシュタグ別件数）
- [ ] 統計数値がリアルタイムで更新（ミュート追加/削除時）
- [ ] レスポンシブ対応でモバイル・デスクトップ両対応

#### 1.3 タブ切り替え機能
- [ ] 「すべて」「ユーザー」「キーワード」「ハッシュタグ」「ドメイン」タブ切り替え
- [ ] タブ別ミュートリスト表示・フィルタリング動作
- [ ] 空の状態での適切なメッセージ表示

### 2. ユーザーミュート機能 ✅

#### 2.1 ユーザーミュート追加
- [ ] 「ミュート追加」ボタンクリックでダイアログ開く
- [ ] ミュートタイプ「ユーザー」選択
- [ ] ユーザー検索フィールドで2文字以上入力時に検索実行
- [ ] 検索結果からユーザー選択可能
- [ ] 自分自身のミュート追加が拒否される（エラーメッセージ表示）
- [ ] 既にミュートしたユーザーの重複追加が拒否される
- [ ] ミュート期間設定（永続・期間限定）選択可能
- [ ] 期間限定選択時のDateTimePicker表示・日時選択
- [ ] 適用範囲の個別切り替え（投稿・コメント・通知・タイムライン・検索）
- [ ] ミュート理由の入力（任意・500文字制限）
- [ ] 「ミュート」ボタンでミュート作成・成功メッセージ表示

#### 2.2 ユーザーミュート表示
- [ ] ミュートユーザー一覧でユーザー名・アバター表示
- [ ] 「user」ラベルのタイプ表示
- [ ] 期間限定ミュートでの期限日時表示・Scheduleアイコン
- [ ] ミュート理由表示（設定済み時）
- [ ] 適用範囲チップの表示（投稿・コメント等の日本語ラベル）
- [ ] ミュート作成日時表示

#### 2.3 ユーザーミュート編集・削除
- [ ] 編集ボタン（Editアイコン）クリックで編集ダイアログ開く
- [ ] 適用範囲の個別切り替え可能
- [ ] ミュート理由の編集可能
- [ ] 「更新」ボタンで設定保存・成功メッセージ表示
- [ ] 「ミュート解除」ボタンで削除確認ダイアログ表示
- [ ] 確認後のミュート削除・一覧から削除・成功メッセージ表示

### 3. キーワードミュート機能 ✅

#### 3.1 キーワードミュート追加
- [ ] ミュートタイプ「キーワード」選択
- [ ] キーワード入力フィールド（100文字制限）
- [ ] 「正規表現として扱う」スイッチ切り替え
- [ ] 「大文字小文字を区別」スイッチ切り替え
- [ ] 期間・適用範囲・理由設定（ユーザーミュートと同様）
- [ ] キーワード空白時のエラー表示
- [ ] 100文字超過時のエラー表示
- [ ] 同一キーワードの重複追加拒否

#### 3.2 キーワードミュート表示
- [ ] キーワード表示（Keyboardアイコン）
- [ ] 正規表現設定時の「正規表現」チップ表示
- [ ] 大小文字区別設定の表示（内部設定・UI表示は任意）
- [ ] その他表示項目はユーザーミュートと同様

#### 3.3 キーワードマッチング動作
- [ ] 通常キーワード検索での部分一致動作
- [ ] 大文字小文字区別設定での動作差
- [ ] 正規表現キーワードでの高度検索
- [ ] 正規表現エラー時の通常検索フォールバック
- [ ] 日本語キーワードでの正常動作

### 4. ハッシュタグミュート機能 ✅

#### 4.1 ハッシュタグミュート追加
- [ ] ミュートタイプ「ハッシュタグ」選択
- [ ] ハッシュタグ入力フィールド（50文字制限・#記号自動削除）
- [ ] 期間・適用範囲・理由設定
- [ ] ハッシュタグ空白時のエラー表示
- [ ] 50文字超過時のエラー表示
- [ ] 同一ハッシュタグの重複追加拒否

#### 4.2 ハッシュタグミュート表示
- [ ] ハッシュタグ表示（#付き・Tagアイコン）
- [ ] その他表示項目はユーザーミュートと同様

### 5. ドメインミュート機能 ✅

#### 5.1 ドメインミュート追加
- [ ] ミュートタイプ「ドメイン」選択
- [ ] ドメイン入力フィールド（100文字制限）
- [ ] 期間・適用範囲・理由設定
- [ ] ドメイン空白時のエラー表示
- [ ] 同一ドメインの重複追加拒否

#### 5.2 ドメインミュート表示
- [ ] ドメイン表示（Languageアイコン）
- [ ] その他表示項目はユーザーミュートと同様

### 6. 期間限定ミュート機能 ✅

#### 6.1 期間設定
- [ ] 「期間限定」選択時のDateTimePicker表示
- [ ] 現在時刻より後の日時のみ選択可能
- [ ] 過去日時設定時のエラー表示
- [ ] 日本語ロケール対応（date-fns ja）

#### 6.2 期限管理
- [ ] 期限付きミュートでの期限日時表示（Scheduleアイコン）
- [ ] MongoDB TTL機能での自動削除
- [ ] `cleanupExpiredMutes()` メソッドでの手動クリーンアップ
- [ ] API呼び出し時の期限切れミュート自動削除

### 7. API エンドポイント動作 ✅

#### 7.1 GET `/api/privacy/mute` - ミュートリスト取得
- [ ] 認証チェック（401エラー）
- [ ] type パラメータでのフィルタリング
- [ ] page・limit パラメータでのページネーション
- [ ] ミュート統計情報の取得
- [ ] targetUserId populate（ユーザー情報取得）
- [ ] レスポンス形式確認（mutes・pagination・stats）

#### 7.2 POST `/api/privacy/mute` - ミュート作成
- [ ] 認証チェック（401エラー）
- [ ] リクエストボディバリデーション
- [ ] 自分自身のミュート拒否（400エラー）
- [ ] 存在しないユーザーのミュート拒否（404エラー）
- [ ] 重複ミュートの拒否（409エラー）
- [ ] 期間限定ミュートでの期限チェック
- [ ] MongoDB保存・populate後のレスポンス

#### 7.3 DELETE `/api/privacy/mute` - ミュート削除
- [ ] 認証チェック（401エラー）
- [ ] muteId パラメータチェック（400エラー）
- [ ] 自分のミュートのみ削除可能（404エラー）
- [ ] MongoDB削除成功

#### 7.4 PATCH `/api/privacy/mute` - ミュート更新
- [ ] 認証チェック（401エラー）
- [ ] muteId・更新データのバリデーション
- [ ] 自分のミュートのみ更新可能（404エラー）
- [ ] scope・reason・isActive の更新
- [ ] populate後のレスポンス

### 8. ミュートチェック機能 ✅

#### 8.1 POST `/api/privacy/mute/check` - 基本ミュートチェック
- [ ] 認証チェック（401エラー）
- [ ] targetUserId・content・hashtags パラメータ対応
- [ ] 期限切れミュート自動クリーンアップ実行
- [ ] ユーザー・キーワード・ハッシュタグの包括チェック
- [ ] boolean値での isMuted レスポンス

#### 8.2 PUT `/api/privacy/mute/check` - バルクミュートチェック
- [ ] 認証チェック（401エラー）
- [ ] items 配列のバリデーション（100件制限）
- [ ] 各アイテムの個別ミュートチェック
- [ ] エラーアイテムのエラー情報付きレスポンス
- [ ] summary統計（total・muted・errors件数）

#### 8.3 GET `/api/privacy/mute/check` - ユーザー専用高速チェック
- [ ] 認証チェック（401エラー）
- [ ] targetUserId パラメータチェック（400エラー）
- [ ] ユーザーミュートのみの高速検索
- [ ] 期限切れ考慮での有効ミュートのみ対象
- [ ] muteDetails付きレスポンス（ミュート詳細情報）

### 9. UI/UX機能 ✅

#### 9.1 ページネーション
- [ ] 10件ずつの表示制限
- [ ] Material-UI Pagination コンポーネント
- [ ] ページ切り替えでの自動読み込み
- [ ] 1ページのみの場合の非表示

#### 9.2 ローディング・エラーハンドリング
- [ ] 初期読み込み時のCircularProgress
- [ ] ミュート追加・削除・更新時のローディング表示
- [ ] 成功・エラーメッセージのAlert表示
- [ ] メッセージ自動非表示（Xボタンでの手動非表示）

#### 9.3 レスポンシブ対応
- [ ] モバイル・タブレット・デスクトップでの適切表示
- [ ] 統計カードのGrid レイアウト調整
- [ ] ダイアログのmaxWidth・fullWidth設定
- [ ] 長いテキストでの適切な折り返し

#### 9.4 アクセシビリティ
- [ ] ARIA ラベルの適切設定
- [ ] キーボードナビゲーション対応
- [ ] 色だけに依存しない情報伝達
- [ ] スクリーンリーダー対応のテキスト情報

### 10. データベース・パフォーマンス ✅

#### 10.1 インデックス最適化
- [ ] 基本インデックス: `{ userId: 1, type: 1 }`
- [ ] 状態インデックス: `{ userId: 1, isActive: 1 }`
- [ ] 一意制約: ユーザーミュート重複防止
- [ ] 部分インデックス: タイプ別効率化
- [ ] 複合インデックス: フィルタリング高速化
- [ ] TTLインデックス: 期限切れ自動削除

#### 10.2 クエリパフォーマンス
- [ ] `getUserMutes()` メソッドでの効率的取得
- [ ] `isMuted()` メソッドでの包括判定
- [ ] `getMuteStats()` aggregation での統計
- [ ] populate での関連データ取得最適化
- [ ] 期限切れミュートの効率的クリーンアップ

### 11. セキュリティ・バリデーション ✅

#### 11.1 認証・認可
- [ ] 全APIエンドポイントでの認証必須
- [ ] 自分のミュートのみアクセス可能
- [ ] セッション検証（getServerSession）

#### 11.2 入力バリデーション
- [ ] キーワード100文字制限・ハッシュタグ50文字制限
- [ ] ミュート理由500文字制限
- [ ] 正規表現の安全な処理（try-catch）
- [ ] SQLインジェクション対策（MongoDBのObjectId検証）

#### 11.3 エラーハンドリング
- [ ] 不正なリクエストでの適切なHTTPステータス
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] サーバーエラーログの詳細記録
- [ ] クライアント側エラー情報の適切な制限

---

## 🔍 統合テスト項目

### 12. 他機能との連携 ⚠️ **要実装**

#### 12.1 投稿一覧・詳細ページ
- [ ] PostList.tsx でのミュートチェック統合
- [ ] ミュート済みユーザーの投稿非表示
- [ ] ミュート済みキーワードの投稿非表示
- [ ] ミュート済みハッシュタグの投稿非表示
- [ ] 適用範囲「投稿」設定の反映

#### 12.2 コメント機能
- [ ] CommentItem.tsx でのミュートチェック統合
- [ ] ミュート済みユーザーのコメント非表示
- [ ] ミュート済みキーワードのコメント非表示
- [ ] 適用範囲「コメント」設定の反映

#### 12.3 タイムライン機能
- [ ] Timeline ページでのミュートフィルタリング
- [ ] フォローユーザーの投稿でもミュート適用
- [ ] 適用範囲「タイムライン」設定の反映

#### 12.4 通知機能
- [ ] 通知一覧でのミュートフィルタリング
- [ ] ミュート済みユーザーからの通知非表示
- [ ] 適用範囲「通知」設定の反映

#### 12.5 検索機能
- [ ] 検索結果でのミュートフィルタリング
- [ ] ミュート済みコンテンツの検索結果非表示
- [ ] 適用範囲「検索」設定の反映

### 13. パフォーマンス・スケーラビリティ ✅

#### 13.1 大量データ処理
- [ ] 1000件以上のミュートでの管理画面パフォーマンス
- [ ] 大量投稿でのミュートチェック速度
- [ ] バルクミュートチェックでの100件処理速度

#### 13.2 リアルタイム性
- [ ] ミュート追加後の即座反映
- [ ] 期間限定ミュートの正確な期限管理
- [ ] 期限切れミュートの適切な無効化

---

## 📝 テスト完了確認

### Phase 2-A 完了条件 ✅
- [ ] 全10項目の基本機能テスト完了
- [ ] 全4タイプのミュート機能動作確認
- [ ] 全4つのAPIエンドポイント動作確認
- [ ] UI/UX・パフォーマンス・セキュリティ項目確認

### 統合テスト必須項目 ⚠️ **要実装・要確認**
- [ ] 投稿一覧でのミュート適用確認
- [ ] タイムラインでのミュート適用確認
- [ ] 通知機能でのミュート適用確認
- [ ] 検索機能でのミュート適用確認

---

## 🚨 重要注意事項

### 現在の実装状況
- ✅ **ミュート管理機能**: 完全実装・UI/API完成
- ⚠️ **ミュート適用機能**: 未実装・PostList等でのフィルタリング必要
- ⚠️ **統合テスト**: 各機能でのミュートチェック呼び出し実装必要

### 次のフェーズで実装必須
1. **PostListコンポーネント**: ミュートチェック統合
2. **CommentItemコンポーネント**: ミュートフィルタリング
3. **Timelineページ**: ミュート適用
4. **通知機能**: ミュート適用
5. **検索機能**: ミュート適用

### テスト実行時の推奨順序
1. **管理機能テスト** (項目1-11): ミュート管理画面での全機能確認
2. **API単体テスト** (項目7-8): Postman等での直接API確認
3. **統合テスト** (項目12): 各機能でのミュート適用確認
4. **パフォーマンステスト** (項目13): 大量データでの動作確認

---

**Issue #30 Phase 2-A ミュート機能テスト完了後、Phase 2-B コンテンツフィルタリング統合の実装に進行します。**