# ログイン機能テスト手順書

**Phase 2認証基盤** - NextAuth.js v4統合ログイン機能の完全テスト手順

## 📋 テスト環境準備

### 前提条件
- 開発サーバーが起動済み (`npm run dev`)
- MongoDBが起動済み・接続確認済み
- メール送信機能が動作済み（さくらSMTP）
- テスト用ユーザーデータが用意済み

### 必要なテストユーザー

```bash
# MongoDB接続して確認
mongosh board-app
db.users.find().pretty()
```

**テストユーザー例**
```javascript
// 1. 認証済みユーザー（正常ログインテスト用）
{
  email: "test-verified@example.com",
  name: "認証済みテストユーザー",
  emailVerified: new Date(),
  password: "TestPass123!" // bcryptハッシュ化済み
}

// 2. 未認証ユーザー（認証エラーテスト用）
{
  email: "test-unverified@example.com", 
  name: "未認証テストユーザー",
  emailVerified: null,
  password: "TestPass123!" // bcryptハッシュ化済み
}
```

---

## 🧪 テスト項目と手順

### 1. 正常なログインフロー ✅

**目的**: 認証済みユーザーのログイン成功を確認

#### 手順
1. **ブラウザーで `http://localhost:3010/login` にアクセス**
2. **フォーム入力**
   - メールアドレス: `test-verified@example.com`
   - パスワード: `TestPass123!`
3. **「ログイン」ボタンクリック**

#### チェックポイント ✅
- [ ] フォームバリデーション通過（エラー無し）
- [ ] ローディング状態表示（CircularProgress）
- [ ] ログイン処理実行（Network tab確認）
- [ ] `/dashboard` へ自動リダイレクト
- [ ] ヘッダーにユーザー名表示
- [ ] AuthButtonが「ログアウト」に変更

#### 期待結果
```
✅ ログイン成功
✅ URL: http://localhost:3010/dashboard
✅ ヘッダー表示: "認証済みテストユーザー | ログアウト"
```

---

### 2. 間違ったパスワード ❌

**目的**: 不正認証時のエラーハンドリング確認

#### 手順
1. **ログイン画面で入力**
   - メールアドレス: `test-verified@example.com`
   - パスワード: `WrongPassword123` （間違ったパスワード）
2. **「ログイン」ボタンクリック**

#### チェックポイント ❌
- [ ] エラーメッセージ表示: **「メールアドレスまたはパスワードが正しくありません」**
- [ ] リダイレクトされない（ログイン画面維持）
- [ ] フォームクリアされない（再入力可能）
- [ ] セッション作成されない
- [ ] ヘッダーが未認証状態維持（「ログイン」ボタン表示）

#### 期待結果
```
❌ ログイン失敗
❌ Alert表示: "メールアドレスまたはパスワードが正しくありません"
❌ URL: http://localhost:3010/login (変更無し)
```

---

### 3. 未認証メールアドレス ⚠️

**目的**: メール未認証ユーザーのログイン制御確認

#### 手順
1. **ログイン画面で入力**
   - メールアドレス: `test-unverified@example.com`
   - パスワード: `TestPass123!`
2. **「ログイン」ボタンクリック**

#### チェックポイント ⚠️
- [ ] エラーメッセージ表示: **「メール認証が完了していません。メールに送信された認証リンクをクリックしてください。」**
- [ ] リダイレクトされない
- [ ] セッション作成されない
- [ ] コンソールログ確認: `❌ Email not verified: test-unverified@example.com`

#### 期待結果
```
⚠️ 認証ブロック
⚠️ Alert表示: "メール認証が完了していません。メールに送信された認証リンクをクリックしてください。"
⚠️ URL: http://localhost:3010/login (変更無し)
```

---

### 4. ログアウト処理 🚪

**目的**: セッション削除・UI更新の確認

#### 手順
1. **事前にログイン済み状態にする**（テスト1完了後）
2. **ヘッダーの「ログアウト」ボタンクリック**
3. **確認ダイアログで「ログアウト」選択**

#### チェックポイント 🚪
- [ ] セッション削除実行
- [ ] `/` (ホーム)へリダイレクト
- [ ] ヘッダーUI更新: **「ログイン」ボタン表示**
- [ ] 保護されたページアクセス不可確認
- [ ] ブラウザーリロードでもログアウト状態維持

#### 期待結果
```
🚪 ログアウト成功
🚪 URL: http://localhost:3010/
🚪 ヘッダー表示: "ログイン | 登録"
```

#### 追加確認
**`/dashboard` に直接アクセス**
- [ ] 自動で `/login` にリダイレクト
- [ ] セッション無効確認

---

### 5. セッション維持の確認 🔄

**目的**: セッション永続化・自動更新確認

#### 手順A: ブラウザーリロード
1. **ログイン完了状態で**
2. **ブラウザーリロード (F5 or Ctrl+R)**

#### チェックポイントA 🔄
- [ ] セッション維持（再ログイン不要）
- [ ] ヘッダーUIが正しく表示
- [ ] ユーザー情報保持

#### 手順B: タブ切り替え
1. **新しいタブで `http://localhost:3010/dashboard` 開く**
2. **元タブに戻る**

#### チェックポイントB 🔄
- [ ] セッション共有確認
- [ ] 両タブで認証状態同期
- [ ] **セッション自動更新** (refetchOnWindowFocus: true)

#### 手順C: 長時間放置
1. **5分以上放置**
2. **ページ操作実行**

#### チェックポイントC 🔄
- [ ] **セッション自動更新** (refetchInterval: 5分)
- [ ] 認証状態維持
- [ ] API呼び出し継続可能

---

### 6. ヘッダー表示の切り替え 🎭

**目的**: 認証状態に応じたUI更新確認

#### AuthButton表示パターン

| 認証状態 | 表示内容 | ボタン |
|---------|----------|--------|
| **未認証** | `ログイン \| 登録` | 2個のボタン |
| **認証済み** | `ユーザー名 \| ログアウト` | ログアウトボタン |
| **読込中** | `Loading...` | 無効化 |

#### 手順
1. **未認証状態確認**: ホームページ (`/`)
2. **ログイン実行**: 認証済み状態移行
3. **ログアウト実行**: 未認証状態復帰

#### チェックポイント 🎭
- [ ] **未認証時**: 「ログイン」「登録」ボタン表示
- [ ] **認証済み**: ユーザー名 + 「ログアウト」ボタン
- [ ] **読込中**: ローディング表示・操作無効化
- [ ] **切り替えアニメーション**: スムーズなUI更新

---

## 🚀 追加テスト: callbackURL機能

**目的**: ログイン後の元ページ復帰確認

### 手順
1. **未認証状態で `/members-only` にアクセス**
2. **自動で `/login?callbackUrl=%2Fmembers-only` にリダイレクト**
3. **正常ログイン実行**

### チェックポイント 🎯
- [ ] callbackURL付きでリダイレクト
- [ ] ログイン成功後に `/members-only` へ自動復帰
- [ ] URLエンコード/デコード正常処理
- [ ] ソーシャルログインでもcallbackURL継承

---

## 🐛 エラー時のデバッグ手順

### MongoDB接続確認
```bash
# ユーザーデータ確認
mongosh board-app
db.users.find({email: "test-verified@example.com"}).pretty()
```

### ログ確認
**サーバーコンソール**
```
✅ Login successful: test-verified@example.com
❌ User not found: wrong@email.com
❌ Email not verified: test-unverified@example.com
❌ Invalid password for: test-verified@example.com
```

**ブラウザー開発者ツール**
- **Network tab**: `/api/auth/signin` API呼び出し確認
- **Console**: エラーメッセージ・警告確認
- **Application → Cookies**: `next-auth.session-token` 確認

### よくある問題と解決策

| 問題 | 原因 | 解決策 |
|------|------|--------|
| ログインボタン反応しない | JavaScript エラー | ブラウザーコンソール確認 |
| `500 Internal Server Error` | MongoDB接続エラー | `MONGODB_URI` 環境変数確認 |
| セッション維持されない | `NEXTAUTH_SECRET` 未設定 | `.env.local` 確認 |
| リダイレクトしない | `NEXTAUTH_URL` 設定問題 | ポート番号確認(3010) |

---

## 📊 テスト完了チェックリスト

**基本認証機能**
- [ ] ✅ 正常ログイン成功
- [ ] ❌ パスワード間違いエラー
- [ ] ⚠️ メール未認証エラー
- [ ] 🚪 ログアウト処理
- [ ] 🔄 セッション維持・自動更新
- [ ] 🎭 ヘッダー表示切り替え

**拡張機能**
- [ ] 🎯 callbackURL機能
- [ ] 🌐 ソーシャルログイン (Google/GitHub)
- [ ] 📱 レスポンシブデザイン

**品質保証**
- [ ] 🐛 エラーハンドリング
- [ ] 🔒 セキュリティ確認
- [ ] ⚡ パフォーマンス (< 500ms)

## 🎯 成功基準

**全テスト項目が期待結果通りに動作すること**
- 認証済みユーザーの正常ログイン
- 不正認証の適切なエラー表示
- セッション管理の完全動作
- UI/UXの一貫した表示更新

**パフォーマンス目標達成**
- ログイン応答時間 < 500ms
- UI更新のスムーズさ
- エラー時の適切なフィードバック

すべてのチェックポイントが ✅ になれば、Phase 2認証基盤は本番運用準備完了です！