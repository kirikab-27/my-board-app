# Phase 4.5: 会員制掲示板CRUD機能拡張 🚧 **実装準備中**

## 📋 概要

Phase 4.5では、既存の会員制掲示板に本格的なCRUD機能を追加します。タイトル付き投稿、詳細ページ、編集権限管理を実装し、会員限定の投稿プラットフォームとして完成させます。

## ✅ 実装予定機能

### 🎯 Phase 4.5の実装目標

- **タイトル付き投稿**: タイトル（100文字制限）+ コンテンツ（1000文字制限）
- **投稿詳細ページ**: 個別投稿の表示・いいね・編集削除リンク
- **投稿編集機能**: 作成者のみ編集可能・権限チェック
- **投稿作成フォーム**: 認証必須・リアルタイム文字数カウント
- **権限管理**: 会員限定投稿・本人のみ編集削除

### 📄 実装対象ページ

#### 1. 投稿作成ページ (`/board/create`)

- **認証必須**: AuthGuard保護・未ログインは/loginへリダイレクト
- **フォーム**: タイトル（100文字）・コンテンツ（1000文字）・リアルタイム文字カウント
- **バリデーション**: 前後バリデーション・Zod統合・エラー表示
- **UI/UX**: Material-UI統合・レスポンシブ・保存中ローディング

#### 2. 投稿詳細ページ (`/board/[id]`)

- **表示内容**: タイトル・コンテンツ・作成者・作成日時・いいね数
- **インタラクション**: いいね機能・作成者のみ編集削除ボタン表示
- **ナビゲーション**: 掲示板一覧へ戻るリンク・次/前の投稿ナビゲーション
- **権限制御**: 未ログインでも閲覧可・操作は認証必須

#### 3. 投稿編集ページ (`/board/[id]/edit`)

- **権限チェック**: 本人のみアクセス可・他人の投稿は404またはアクセス拒否
- **フォーム**: 既存データ取得・タイトル+コンテンツ編集・文字数カウント
- **更新機能**: PUT API呼び出し・更新後は詳細ページへリダイレクト
- **キャンセル**: 編集をキャンセル・詳細ページへ戻る

## 🛠️ 技術仕様

### データベース設計（Postモデル拡張）

```typescript
// 拡張予定のPostモデル
interface IPost {
  _id: string;
  title: string; // 🚧 新規追加: タイトル（最大100文字・必須）
  content: string; // 🚧 拡張: 1000文字に制限拡張（現在200文字）
  likes: number;
  likedBy: string[];
  userId: string; // 🚧 変更: 必須フィールドに（会員限定投稿のため）
  authorName: string;
  isPublic: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

### API エンドポイント拡張

```typescript
// 新規実装予定API
GET / api / posts / [id]; // 投稿詳細取得
PUT / api / posts / [id]; // 投稿更新（拡張・権限チェック強化）
DELETE / api / posts / [id]; // 投稿削除（権限チェック強化）

// 既存API拡張
POST / api / posts; // 投稿作成（title対応・文字数制限拡張）
GET / api / posts; // 投稿一覧（title表示対応）
```

### バリデーション設計

```typescript
// Zodスキーマ拡張
const createPostSchema = z.object({
  title: z
    .string()
    .min(1, 'タイトルは必須です')
    .max(100, 'タイトルは100文字以内で入力してください'),
  content: z
    .string()
    .min(1, '投稿内容は必須です')
    .max(1000, '投稿内容は1000文字以内で入力してください'),
});

const updatePostSchema = z
  .object({
    title: z.string().max(100).optional(),
    content: z.string().max(1000).optional(),
  })
  .refine((data) => data.title || data.content, {
    message: 'タイトルまたは内容を更新してください',
  });
```

## 📂 ファイル構成（実装予定）

```
src/
├── app/
│   ├── api/
│   │   └── posts/
│   │       ├── [id]/
│   │       │   ├── route.ts        # GET 投稿詳細・PUT 投稿更新・DELETE 投稿削除
│   │       │   └── like/           # 既存いいね機能（変更なし）
│   │       └── route.ts            # POST 投稿作成（title対応）・GET 一覧（title対応）
│   └── board/
│       ├── create/
│       │   └── page.tsx            # 🚧 投稿作成ページ（新規実装）
│       ├── [id]/
│       │   ├── page.tsx            # 🚧 投稿詳細ページ（新規実装）
│       │   └── edit/
│       │       └── page.tsx        # 🚧 投稿編集ページ（新規実装）
│       └── page.tsx                # 既存一覧ページ（title表示対応）
├── components/
│   ├── board/                      # 🚧 新規ディレクトリ
│   │   ├── PostCreateForm.tsx      # 投稿作成フォーム
│   │   ├── PostDetailCard.tsx      # 投稿詳細表示カード
│   │   ├── PostEditForm.tsx        # 投稿編集フォーム
│   │   └── PostNavigator.tsx       # 前/次の投稿ナビゲーション
│   ├── PostForm.tsx                # 🚧 拡張: title対応・文字数制限変更
│   └── PostList.tsx                # 🚧 拡張: title表示対応
└── models/
    └── Post.ts                     # 🚧 拡張: titleフィールド追加・content制限変更
```

## 🎨 UI/UX 設計

### デザインコンセプト

- **一貫性**: 既存のMaterial-UIテーマ・色彩設計継続
- **階層構造**: 一覧 → 詳細 → 編集の明確なナビゲーション
- **権限表示**: 編集削除ボタンは作成者のみ表示・視覚的権限管理
- **レスポンシブ**: モバイル・タブレット・デスクトップ対応

### 投稿作成フォーム

```typescript
// UI要素
- タイトル入力: TextField（1行・100文字制限・必須）
- コンテンツ入力: TextField（複数行・1000文字制限・必須）
- 文字数カウント: リアルタイム表示「45/100文字」
- 投稿ボタン: 文字数制限内でのみ有効化・ローディング表示
- キャンセルボタン: 確認ダイアログ後に一覧ページへ戻る
```

### 投稿詳細ページ

```typescript
// レイアウト
- ヘッダー: タイトル（大きなフォント）・作成者・作成日時
- コンテンツ: 改行保持・長文対応スクロール
- アクション: いいねボタン・編集ボタン（作成者のみ）・削除ボタン（作成者のみ）
- ナビゲーション: 「一覧に戻る」・「前の投稿」・「次の投稿」
```

## 🔐 権限管理・セキュリティ

### 認証・権限チェック

```typescript
// API権限チェックロジック
1. 投稿作成: ログイン必須・有効セッション確認
2. 投稿詳細: 認証不要（閲覧のみ）・いいねは認証必須
3. 投稿編集: 作成者のみ・userId一致確認
4. 投稿削除: 作成者のみ・管理者権限も考慮（将来）
```

### セキュリティ対策

- **XSS対策**: HTMLエスケープ・改行のみ許可（`whiteSpace: 'pre-wrap'`）
- **CSRF対策**: NextAuth.js CSRFトークン統合
- **入力検証**: フロント・バックエンド両方で文字数制限・必須チェック
- **権限検証**: 投稿編集・削除時のuserId一致確認必須

## 📱 ブランチ戦略・実装手順

### ブランチ戦略

```bash
# 現在のブランチ: feature/monitoring
# 実装ブランチ: feature/member-board

1. feature/profile-management → feature/member-board マージ
2. Postモデル拡張・スキーマ変更・マイグレーション
3. API拡張実装・権限チェック強化
4. フロントエンドページ実装・UI/UX完成
5. テスト・動作確認・Phase 4.5完了
6. feature/member-board → develop マージ
7. phase-4.5-complete タグ作成
```

### 実装フェーズ

#### フェーズ1: バックエンド実装（0.5日）

1. Postモデルにtitleフィールド追加・content制限変更
2. API拡張: GET/PUT/DELETE /api/posts/[id]
3. バリデーション追加・権限チェック強化
4. 既存データマイグレーション（titleフィールド追加）

#### フェーズ2: フロントエンド実装（1日）

1. `/board/create` 投稿作成ページ実装
2. `/board/[id]` 投稿詳細ページ実装
3. `/board/[id]/edit` 投稿編集ページ実装
4. 既存PostForm・PostList拡張（title対応）

#### フェーズ3: UI/UX・テスト（0.5日）

1. レスポンシブ対応・Material-UI調整
2. 権限表示・エラーハンドリング強化
3. E2Eテスト実装・動作確認
4. ドキュメント更新・Phase 4.5完了

## 🚧 実装時の注意事項

### 既存機能への影響

- **後方互換性**: 既存投稿データのtitleは空文字・content制限は段階的移行
- **API変更**: 既存API拡張のみ・破綻的変更なし
- **UI変更**: 一覧ページのtitle表示は任意・既存レイアウト維持

### データ移行

```javascript
// 既存投稿データ移行スクリプト（実装予定）
// scripts/migrate-posts-title.js
db.posts.updateMany(
  { title: { $exists: false } },
  { $set: { title: '', content: { $substr: ['$content', 0, 200] } } }
);
```

### パフォーマンス考慮

- **ページネーション**: 既存の仕組み継続・詳細ページは個別取得
- **インデックス**: MongoDB titleフィールドインデックス追加検討
- **キャッシュ**: 投稿詳細のクライアントサイドキャッシュ実装

## 📊 テスト戦略

### テストケース

```bash
# ユニットテスト
- Postモデル: titleバリデーション・文字数制限
- API: 権限チェック・CRUD操作・エラーハンドリング

# 統合テスト
- 投稿作成フロー: 作成→詳細→編集→削除
- 権限テスト: 他人の投稿編集アクセス拒否

# E2Eテスト
- 完全な投稿ライフサイクル
- レスポンシブUI動作確認
```

## 📈 成功指標

- **機能完成度**: 全CRUD操作が正常動作・権限管理完備
- **UI/UX品質**: レスポンシブ対応・Material-UI一貫性維持
- **セキュリティ**: XSS・CSRF対策実装・権限チェック完備
- **パフォーマンス**: ページロード < 2秒・API応答 < 500ms
- **テストカバレッジ**: 80%以上・主要機能のE2Eテスト完備

---

**Phase 4.5実装完了後、会員制掲示板として完全な機能を提供し、Phase 5のセキュリティ強化へ進みます。**
