'use client';

import { useState, useEffect, useCallback } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { useSession } from 'next-auth/react';
import {
  Container,
  Paper,
  Typography,
  Box,
  TextField,
  InputAdornment,
  CircularProgress,
  AppBar,
  Toolbar,
  Alert,
  Chip,
  IconButton,
  Menu,
  MenuItem,
  Fade,
  Divider,
  FormControl,
  InputLabel,
  Select,
  Avatar
} from '@mui/material';
import SearchIcon from '@mui/icons-material/Search';
import ClearIcon from '@mui/icons-material/Clear';
import FilterListIcon from '@mui/icons-material/FilterList';
import HistoryIcon from '@mui/icons-material/History';
import TrendingUpIcon from '@mui/icons-material/TrendingUp';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import { AuthButton } from '@/components/auth/AuthButton';
import ProfileAvatar from '@/components/profile/ProfileAvatar';
import Link from 'next/link';

interface User {
  _id: string;
  name: string;
  username: string;
  displayName: string;
  email: string;
  avatar?: string;
  bio: string;
  location?: string;
  website?: string;
  isVerified: boolean;
  isOnline: boolean;
  lastSeen: string;
  stats: {
    postsCount: number;
    followersCount: number;
    followingCount: number;
  };
  createdAt: string;
}

interface SearchResponse {
  users: User[];
  suggestedUsers: User[];
  searchMeta: {
    query: string;
    normalizedQuery: string;
    filter: string;
    sortBy: string;
    hasResults: boolean;
  };
  pagination: {
    currentPage: number;
    totalPages: number;
    totalCount: number;
    limit: number;
    hasNextPage: boolean;
    hasPrevPage: boolean;
  };
  error?: string; // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ôºà„Ç®„É©„ÉºÊôÇ„ÅÆ„ÅøÔºâ
}

export default function UserSearchPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { data: session } = useSession();
  
  const [searchQuery, setSearchQuery] = useState(searchParams?.get('q') || '');
  const [users, setUsers] = useState<User[]>([]);
  const [suggestedUsers, setSuggestedUsers] = useState<User[]>([]);
  const [searchHistory, setSearchHistory] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [searchMeta, setSearchMeta] = useState<any>(null);
  const [pagination, setPagination] = useState<any>(null);
  
  // „Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö
  const [sortBy, setSortBy] = useState('relevance');
  const [filter, setFilter] = useState('all');
  const [filterAnchorEl, setFilterAnchorEl] = useState<null | HTMLElement>(null);
  
  const [showSearchHistory, setShowSearchHistory] = useState(false);

  // ÂàùÊúü„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
  useEffect(() => {
    loadSearchHistory();
    if (!searchQuery) {
      // Ê§úÁ¥¢„Å™„Åó„ÅÆÂ†¥Âêà„ÅØ„Åä„Åô„Åô„ÇÅ„É¶„Éº„Ç∂„Éº„ÇíË°®Á§∫
      performSearch('', 1);
    }
  }, []);

  // URL „Éë„É©„É°„Éº„Çø„Åã„Çâ„ÅÆÊ§úÁ¥¢ÂÆüË°å
  useEffect(() => {
    const q = searchParams?.get('q');
    if (q && q !== searchQuery) {
      setSearchQuery(q);
      performSearch(q, 1);
    }
  }, [searchParams]);

  // „ÇΩ„Éº„Éà„Éª„Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥ÊôÇ„ÅÆÂÜçÊ§úÁ¥¢
  useEffect(() => {
    // ÂàùÊúüÂåñÊôÇ„ÅØÂÆüË°å„Åó„Å™„ÅÑ
    if (sortBy !== 'relevance' || filter !== 'all') {
      performSearch(searchQuery, 1);
    }
  }, [sortBy, filter]);

  // Ê§úÁ¥¢ÂÆüË°åÈñ¢Êï∞
  const performSearch = useCallback(async (query: string, page: number = 1) => {
    setLoading(true);
    setError(null);
    
    try {
      const params = new URLSearchParams({
        search: query,
        page: page.toString(),
        limit: '20',
        sortBy,
        filter
      });
      
      const response = await fetch(`/api/users?${params}`);
      const data: SearchResponse = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || '„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
      
      if (page === 1) {
        setUsers(data.users);
      } else {
        setUsers(prev => [...prev, ...data.users]);
      }
      
      setSuggestedUsers(data.suggestedUsers || []);
      setSearchMeta(data.searchMeta);
      setPagination(data.pagination);
      
    } catch (err) {
      setError(err instanceof Error ? err.message : '„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    } finally {
      setLoading(false);
    }
  }, [sortBy, filter]);

  // ÂÖ•Âäõ„Éè„É≥„Éâ„É©„ÉºÔºàÊ§úÁ¥¢ÂÆüË°å„Å™„ÅóÔºâ
  const handleSearchInput = (value: string) => {
    setSearchQuery(value);
    setShowSearchHistory(value.length === 0);
  };

  // Ê§úÁ¥¢ÂÆüË°å„Éè„É≥„Éâ„É©„Éº
  const executeSearch = () => {
    performSearch(searchQuery, 1);
    if (searchQuery) {
      // URLÊõ¥Êñ∞
      router.replace(`/users/search?q=${encodeURIComponent(searchQuery)}`);
    } else {
      router.replace('/users/search');
    }
    setShowSearchHistory(false);
  };

  // „Ç®„É≥„Çø„Éº„Ç≠„ÉºÊäº‰∏ãÊôÇ„ÅÆÂá¶ÁêÜ
  const handleKeyDown = (event: React.KeyboardEvent) => {
    if (event.key === 'Enter') {
      executeSearch();
    }
  };

  // Ê§úÁ¥¢Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
  const loadSearchHistory = async () => {
    try {
      const response = await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'getSearchHistory' })
      });
      const data = await response.json();
      setSearchHistory(data.history || []);
    } catch (error) {
      console.error('Ê§úÁ¥¢Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
    }
  };

  // Ê§úÁ¥¢Â±•Ê≠¥„ÇØ„É™„Ç¢
  const clearSearchHistory = async () => {
    try {
      await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'clearSearchHistory' })
      });
      setSearchHistory([]);
    } catch (error) {
      console.error('Ê§úÁ¥¢Â±•Ê≠¥„ÇØ„É™„Ç¢„Ç®„É©„Éº:', error);
    }
  };

  // „Éï„Ç£„É´„Çø„Éº„É°„Éã„É•„Éº
  const handleFilterClick = (event: React.MouseEvent<HTMLElement>) => {
    setFilterAnchorEl(event.currentTarget);
  };

  const handleFilterClose = () => {
    setFilterAnchorEl(null);
  };

  // „É¶„Éº„Ç∂„Éº„Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„Éè„É≥„Éâ„É©„Éº
  const handleUserCardClick = (user: User) => {
    // username„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆÂÆâÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ
    if (!user.username) {
      console.error('„É¶„Éº„Ç∂„ÉºÂêç„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì:', user);
      return;
    }
    
    // ÁèæÂú®„ÅÆÊ§úÁ¥¢„ÇØ„Ç®„É™„ÇísessionStorage„Å´‰øùÂ≠ò
    if (searchQuery) {
      sessionStorage.setItem('lastSearchQuery', searchQuery);
    }
    
    // „É¶„Éº„Ç∂„ÉºÊäïÁ®ø‰∏ÄË¶ß„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª
    router.push(`/users/${user.username}/posts`);
  };

  // „É¶„Éº„Ç∂„Éº„Ç´„Éº„Éâ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
  const UserCard = ({ user }: { user: User }) => (
    <Paper 
      sx={{ 
        p: 2, 
        mb: 2,
        cursor: 'pointer',
        transition: 'all 0.2s ease-in-out',
        '&:hover': {
          transform: 'translateY(-2px)',
          boxShadow: 3,
          bgcolor: 'action.hover'
        }
      }}
      onClick={() => handleUserCardClick(user)}
    >
      <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
        {user.avatar ? (
          <Avatar
            src={user.avatar}
            alt={user.displayName}
            sx={{ width: 56, height: 56 }}
          />
        ) : (
          <ProfileAvatar 
            name={user.displayName} 
            size="medium" 
          />
        )}
        
        <Box sx={{ flex: 1 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>
            <Typography variant="h6" component="h3">
              {user.displayName}
            </Typography>
            {user.isVerified && (
              <Chip label="Ë™çË®ºÊ∏à„Åø" size="small" color="primary" />
            )}
            {user.isOnline && (
              <Chip label="„Ç™„É≥„É©„Ç§„É≥" size="small" color="success" />
            )}
          </Box>
          
          <Typography variant="body2" color="text.secondary" gutterBottom>
            @{user.username}
          </Typography>
          
          {user.bio && (
            <Typography variant="body2" sx={{ mb: 1 }}>
              {user.bio}
            </Typography>
          )}
          
          {user.location && (
            <Typography variant="caption" color="text.secondary">
              üìç {user.location}
            </Typography>
          )}
          
          <Box sx={{ display: 'flex', gap: 2, mt: 1 }}>
            <Typography variant="caption">
              <strong>{user.stats.postsCount}</strong> ÊäïÁ®ø
            </Typography>
            <Typography variant="caption">
              <strong>{user.stats.followersCount}</strong> „Éï„Ç©„É≠„ÉØ„Éº
            </Typography>
            <Typography variant="caption">
              <strong>{user.stats.followingCount}</strong> „Éï„Ç©„É≠„Éº‰∏≠
            </Typography>
          </Box>
        </Box>
        
        {/* ÊäïÁ®øË°®Á§∫„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
        <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 0.5 }}>
          <Typography variant="caption" color="text.secondary">
            ÊäïÁ®ø„ÇíË¶ã„Çã
          </Typography>
          <Typography variant="h4" color="action">
            ‚Üí
          </Typography>
        </Box>
      </Box>
    </Paper>
  );

  if (!session) {
    return (
      <>
        <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
          <Toolbar>
            <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
              „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢
            </Typography>
            <AuthButton />
          </Toolbar>
        </AppBar>
        <Container maxWidth="md" sx={{ mt: { xs: 14, sm: 16, md: 16 } }}>
          <Alert severity="info">
            „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
          </Alert>
        </Container>
      </>
    );
  }

  return (
    <>
      <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }}>
        <Toolbar>
          <IconButton 
            component={Link} 
            href="/users" 
            edge="start" 
            color="inherit" 
            sx={{ mr: 2 }}
          >
            <ArrowBackIcon />
          </IconButton>
          <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
            „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢
          </Typography>
          <AuthButton />
        </Toolbar>
      </AppBar>

      <Container maxWidth="md" sx={{ mt: { xs: 14, sm: 16, md: 16 }, mb: 4 }}>
        {/* Ê§úÁ¥¢„Éê„Éº */}
        <Paper sx={{ p: 2, mb: 3 }}>
          <Box sx={{ display: 'flex', gap: 1, mb: 2 }}>
            <TextField
              fullWidth
              placeholder="„É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢„Åó„Å¶Enter„Ç≠„Éº„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ (@username, ÂêçÂâç, Ëá™Â∑±Á¥π‰ªã)"
              value={searchQuery}
              onChange={(e) => handleSearchInput(e.target.value)}
              onKeyDown={handleKeyDown}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <IconButton onClick={executeSearch} size="small">
                      <SearchIcon />
                    </IconButton>
                  </InputAdornment>
                ),
                endAdornment: (
                  <InputAdornment position="end">
                    {loading && <CircularProgress size={20} />}
                    {searchQuery && (
                      <IconButton 
                        onClick={() => {
                          handleSearchInput('');
                          router.replace('/users/search');
                          performSearch('', 1);
                        }}
                        size="small"
                      >
                        <ClearIcon />
                      </IconButton>
                    )}
                  </InputAdornment>
                ),
              }}
            />
            
            <IconButton onClick={handleFilterClick}>
              <FilterListIcon />
            </IconButton>
          </Box>
          
          {/* „Éï„Ç£„É´„Çø„Éº„Éª„ÇΩ„Éº„Éà */}
          <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
            <FormControl size="small" sx={{ minWidth: 120 }}>
              <InputLabel>‰∏¶„Å≥È†Ü</InputLabel>
              <Select
                value={sortBy}
                label="‰∏¶„Å≥È†Ü"
                onChange={(e) => setSortBy(e.target.value)}
              >
                <MenuItem value="relevance">Èñ¢ÈÄ£Â∫¶</MenuItem>
                <MenuItem value="followers">„Éï„Ç©„É≠„ÉØ„ÉºÊï∞</MenuItem>
                <MenuItem value="recent">ÁôªÈå≤È†Ü</MenuItem>
                <MenuItem value="active">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</MenuItem>
              </Select>
            </FormControl>
            
            <FormControl size="small" sx={{ minWidth: 120 }}>
              <InputLabel>„Éï„Ç£„É´„Çø„Éº</InputLabel>
              <Select
                value={filter}
                label="„Éï„Ç£„É´„Çø„Éº"
                onChange={(e) => setFilter(e.target.value)}
              >
                <MenuItem value="all">„Åô„Åπ„Å¶</MenuItem>
                <MenuItem value="verified">Ë™çË®ºÊ∏à„Åø„ÅÆ„Åø</MenuItem>
                <MenuItem value="online">„Ç™„É≥„É©„Ç§„É≥„ÅÆ„Åø</MenuItem>
              </Select>
            </FormControl>
          </Box>
        </Paper>

        {/* Ê§úÁ¥¢Â±•Ê≠¥„ÉªÊèêÊ°à */}
        {showSearchHistory && searchHistory.length > 0 && (
          <Fade in={showSearchHistory}>
            <Paper sx={{ mb: 3 }}>
              <Box sx={{ p: 2 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
                  <Typography variant="subtitle2" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                    <HistoryIcon fontSize="small" />
                    ÊúÄËøë„ÅÆÊ§úÁ¥¢
                  </Typography>
                  <IconButton size="small" onClick={clearSearchHistory}>
                    <ClearIcon fontSize="small" />
                  </IconButton>
                </Box>
                <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                  {searchHistory.slice(0, 5).map((term, index) => (
                    <Chip
                      key={index}
                      label={term}
                      size="small"
                      onClick={() => {
                        setSearchQuery(term);
                        setShowSearchHistory(false);
                        performSearch(term, 1);
                        router.replace(`/users/search?q=${encodeURIComponent(term)}`);
                      }}
                      clickable
                    />
                  ))}
                </Box>
              </Box>
            </Paper>
          </Fade>
        )}

        {/* „Ç®„É©„ÉºË°®Á§∫ */}
        {error && (
          <Alert severity="error" sx={{ mb: 3 }}>
            {error}
          </Alert>
        )}

        {/* Ê§úÁ¥¢ÁµêÊûú„É°„ÇøÊÉÖÂ†± */}
        {searchMeta && searchQuery && (
          <Paper sx={{ p: 2, mb: 3, bgcolor: 'grey.50' }}>
            <Typography variant="body2" color="text.secondary">
              &quot;{searchMeta.query}&quot; „ÅÆÊ§úÁ¥¢ÁµêÊûú
              {pagination && (
                <> - {pagination.totalCount}‰ª∂„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü</>
              )}
            </Typography>
          </Paper>
        )}

        {/* „Åä„Åô„Åô„ÇÅ„É¶„Éº„Ç∂„Éº */}
        {!searchQuery && suggestedUsers.length > 0 && (
          <Box sx={{ mb: 4 }}>
            <Typography 
              variant="h6" 
              gutterBottom 
              sx={{ display: 'flex', alignItems: 'center', gap: 1 }}
            >
              <TrendingUpIcon />
              „Åä„Åô„Åô„ÇÅ„É¶„Éº„Ç∂„Éº
            </Typography>
            {suggestedUsers.map((user) => (
              <UserCard key={user._id} user={user} />
            ))}
          </Box>
        )}

        {/* Ê§úÁ¥¢ÁµêÊûú */}
        {searchQuery && (
          <Box>
            <Typography variant="h6" gutterBottom>
              Ê§úÁ¥¢ÁµêÊûú
            </Typography>
            {users.length === 0 && !loading ? (
              <Paper sx={{ p: 4, textAlign: 'center' }}>
                <Typography variant="body1" color="text.secondary">
                  Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                  Âà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ
                </Typography>
              </Paper>
            ) : (
              users.map((user) => (
                <UserCard key={user._id} user={user} />
              ))
            )}
            
            {/* „ÇÇ„Å£„Å®Ë™≠„ÅøËæº„Åø„Éú„Çø„É≥ */}
            {pagination && pagination.hasNextPage && (
              <Box sx={{ textAlign: 'center', mt: 3 }}>
                <button
                  onClick={() => performSearch(searchQuery, pagination.currentPage + 1)}
                  disabled={loading}
                  style={{
                    padding: '12px 24px',
                    border: '1px solid #ddd',
                    borderRadius: '8px',
                    background: 'transparent',
                    cursor: 'pointer'
                  }}
                >
                  {loading ? 'Loading...' : '„ÇÇ„Å£„Å®Ë¶ã„Çã'}
                </button>
              </Box>
            )}
          </Box>
        )}
      </Container>

      {/* „Éï„Ç£„É´„Çø„Éº„É°„Éã„É•„Éº */}
      <Menu
        anchorEl={filterAnchorEl}
        open={Boolean(filterAnchorEl)}
        onClose={handleFilterClose}
      >
        <MenuItem onClick={() => { setSortBy('relevance'); handleFilterClose(); }}>
          Èñ¢ÈÄ£Â∫¶È†Ü
        </MenuItem>
        <MenuItem onClick={() => { setSortBy('followers'); handleFilterClose(); }}>
          „Éï„Ç©„É≠„ÉØ„ÉºÊï∞È†Ü
        </MenuItem>
        <MenuItem onClick={() => { setSortBy('recent'); handleFilterClose(); }}>
          Êñ∞Ë¶èÁôªÈå≤È†Ü
        </MenuItem>
        <MenuItem onClick={() => { setSortBy('active'); handleFilterClose(); }}>
          „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÈ†Ü
        </MenuItem>
        <Divider />
        <MenuItem onClick={() => { setFilter('all'); handleFilterClose(); }}>
          „Åô„Åπ„Å¶„ÅÆ„É¶„Éº„Ç∂„Éº
        </MenuItem>
        <MenuItem onClick={() => { setFilter('verified'); handleFilterClose(); }}>
          Ë™çË®ºÊ∏à„Åø„ÅÆ„Åø
        </MenuItem>
        <MenuItem onClick={() => { setFilter('online'); handleFilterClose(); }}>
          „Ç™„É≥„É©„Ç§„É≥„ÅÆ„Åø
        </MenuItem>
      </Menu>
    </>
  );
}