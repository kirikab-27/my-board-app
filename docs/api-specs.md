# API仕様書

## 1. API概要

### 1.1 基本情報
- **ベースURL**: `/api`
- **プロトコル**: HTTP/HTTPS
- **データ形式**: JSON
- **文字エンコーディング**: UTF-8
- **認証**: なし（オープンAPI）

### 1.2 共通仕様

#### リクエストヘッダー
| ヘッダー名 | 値 | 必須 | 説明 |
|-----------|-----|------|------|
| Content-Type | application/json | POST/PUT時必須 | リクエストボディのコンテンツタイプ |

#### レスポンスヘッダー
| ヘッダー名 | 値 | 説明 |
|-----------|-----|------|
| Content-Type | application/json | レスポンスボディのコンテンツタイプ |

#### エラーレスポンス形式
```json
{
  "error": "エラーメッセージ（日本語）"
}
```

## 2. API詳細

### 2.1 投稿一覧取得

#### 概要
すべての投稿を取得する

#### エンドポイント
```
GET /api/posts
```

#### リクエスト
##### パラメータ
なし

##### リクエストボディ
なし

#### レスポンス
##### 成功時 (200 OK)
```json
[
  {
    "_id": "65abc123def4567890123456",
    "content": "投稿内容のテキスト\n改行も含まれます",
    "createdAt": "2025-01-20T01:30:00.000Z",
    "updatedAt": "2025-01-20T02:45:00.000Z",
    "__v": 0
  },
  {
    "_id": "65abc123def4567890123457",
    "content": "別の投稿内容",
    "createdAt": "2025-01-19T10:15:00.000Z",
    "updatedAt": "2025-01-19T10:15:00.000Z",
    "__v": 0
  }
]
```

##### エラー時 (500 Internal Server Error)
```json
{
  "error": "投稿の取得に失敗しました"
}
```

#### 実装ファイル
`src/app/api/posts/route.ts:5-17`

---

### 2.2 投稿作成

#### 概要
新しい投稿を作成する

#### エンドポイント
```
POST /api/posts
```

#### リクエスト
##### パラメータ
なし

##### リクエストボディ
```json
{
  "content": "投稿内容のテキスト\n改行も含めることができます"
}
```

| フィールド | 型 | 必須 | 説明 | 制約 |
|-----------|-----|------|------|------|
| content | string | ○ | 投稿内容 | 1〜200文字、前後の空白は自動削除 |

#### レスポンス
##### 成功時 (201 Created)
```json
{
  "_id": "65abc123def4567890123458",
  "content": "投稿内容のテキスト\n改行も含めることができます",
  "createdAt": "2025-01-20T03:00:00.000Z",
  "updatedAt": "2025-01-20T03:00:00.000Z",
  "__v": 0
}
```

##### バリデーションエラー (400 Bad Request)

###### 空の投稿
```json
{
  "error": "投稿内容を入力してください"
}
```

###### 文字数超過
```json
{
  "error": "投稿は200文字以内で入力してください"
}
```

##### サーバーエラー (500 Internal Server Error)
```json
{
  "error": "投稿の作成に失敗しました"
}
```

#### 実装ファイル
`src/app/api/posts/route.ts:19-50`

---

### 2.3 投稿更新

#### 概要
既存の投稿を更新する

#### エンドポイント
```
PUT /api/posts/{id}
```

#### リクエスト
##### パスパラメータ
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | string | ○ | 投稿ID（MongoDB ObjectId） |

##### リクエストボディ
```json
{
  "content": "更新後の投稿内容"
}
```

| フィールド | 型 | 必須 | 説明 | 制約 |
|-----------|-----|------|------|------|
| content | string | ○ | 更新後の投稿内容 | 1〜200文字、前後の空白は自動削除 |

#### レスポンス
##### 成功時 (200 OK)
```json
{
  "_id": "65abc123def4567890123456",
  "content": "更新後の投稿内容",
  "createdAt": "2025-01-20T01:30:00.000Z",
  "updatedAt": "2025-01-20T04:00:00.000Z",
  "__v": 0
}
```

##### バリデーションエラー (400 Bad Request)

###### 無効なID
```json
{
  "error": "無効な投稿IDです"
}
```

###### 空の投稿
```json
{
  "error": "投稿内容を入力してください"
}
```

###### 文字数超過
```json
{
  "error": "投稿は200文字以内で入力してください"
}
```

##### 投稿が見つからない (404 Not Found)
```json
{
  "error": "投稿が見つかりません"
}
```

##### サーバーエラー (500 Internal Server Error)
```json
{
  "error": "投稿の更新に失敗しました"
}
```

#### 実装ファイル
`src/app/api/posts/[id]/route.ts:6-58`

---

### 2.4 投稿削除

#### 概要
既存の投稿を削除する

#### エンドポイント
```
DELETE /api/posts/{id}
```

#### リクエスト
##### パスパラメータ
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | string | ○ | 投稿ID（MongoDB ObjectId） |

##### リクエストボディ
なし

#### レスポンス
##### 成功時 (200 OK)
```json
{
  "message": "投稿を削除しました"
}
```

##### バリデーションエラー (400 Bad Request)

###### 無効なID
```json
{
  "error": "無効な投稿IDです"
}
```

##### 投稿が見つからない (404 Not Found)
```json
{
  "error": "投稿が見つかりません"
}
```

##### サーバーエラー (500 Internal Server Error)
```json
{
  "error": "投稿の削除に失敗しました"
}
```

#### 実装ファイル
`src/app/api/posts/[id]/route.ts:60-92`

## 3. ステータスコード一覧

| コード | 説明 | 使用場面 |
|--------|------|----------|
| 200 | OK | 取得・更新・削除成功時 |
| 201 | Created | 作成成功時 |
| 400 | Bad Request | バリデーションエラー、無効なリクエスト |
| 404 | Not Found | リソースが見つからない |
| 500 | Internal Server Error | サーバー内部エラー |

## 4. データモデル

### 4.1 Post（投稿）

| フィールド | 型 | 説明 | 制約 |
|-----------|-----|------|------|
| _id | string | 投稿の一意識別子 | MongoDB ObjectId |
| content | string | 投稿内容 | 必須、最大200文字 |
| createdAt | string | 作成日時 | ISO 8601形式、自動設定 |
| updatedAt | string | 更新日時 | ISO 8601形式、自動更新 |
| __v | number | MongoDBバージョンキー | 自動管理 |

## 5. エラーハンドリング

### 5.1 クライアントエラー（4xx）

#### 400 Bad Request
- 必須パラメータの不足
- バリデーションエラー
- 無効なObjectId形式

#### 404 Not Found
- 指定されたIDの投稿が存在しない

### 5.2 サーバーエラー（5xx）

#### 500 Internal Server Error
- データベース接続エラー
- MongoDBクエリエラー
- 予期しない例外

### 5.3 エラーログ
すべてのエラーは`console.error`でサーバー側にログ出力される

## 6. パフォーマンス考慮事項

### 6.1 データベース接続
- 接続プーリングを使用（mongoose経由）
- グローバル接続キャッシュによる接続の再利用

### 6.2 クエリ最適化
- 投稿一覧は作成日時の降順でソート済み
- `findByIdAndUpdate`で更新と取得を1クエリで実行
- `findByIdAndDelete`で削除を効率的に実行

## 7. セキュリティ考慮事項

### 7.1 入力検証
- サーバーサイドでの文字数チェック
- 空白文字のトリミング
- ObjectIdの形式検証

### 7.2 エラー情報
- 詳細なエラー情報はログのみに出力
- クライアントには一般的なエラーメッセージを返却

## 8. 今後の拡張予定

### 8.1 検討中の機能
- ページネーション機能
- 検索機能
- ソート機能（日付以外）
- 投稿者情報の追加
- 認証・認可機能

### 8.2 API バージョニング
現在はバージョニングなし。将来的には以下を検討：
- URLパスによるバージョニング（例：`/api/v2/posts`）
- ヘッダーによるバージョニング